# How to use this R pipeline and reproduce results
This R code pipeline contains several different R Markdown files that should be run sequentially according their enumeration.
## Requirements 
R version 4.1.2,  R studio 2022.07.01
All data files necessary to run the R code (.biom files) are present in the “/Data folder and are ready to be imported to R. These .biom files are generated by the QIIME2 pipeline present in the“Code/qiime2_preProcessing” folder
### R Package installation
The first chunk of script 1_Loading_and_pre_processing.Rmd has code to install the necessary packages locally (inside your “renv/” folder). You might need to restart R a couple times to install all the packages. The version of each package used in this pipeline present in the “renv.lock” file. You can run a series of commands from the renv package (like renv::restore()) to install the same versions of the same packages. This has not been extensively tested by the authors.
## Sequentially running the pipeline
* The numbered Rmd files should be executed sequentially. Run script 1_Loading_and_pre_processing.Rmd before running script 2_beta_diversity.Rmd, etc.
* Each .Rmd script has numbered chunks that should also be run sequentially. They start loading libraries and data, and finish saving the R environment.
* Each chunk has a unique number that refers to the script and may have subsessions. For example chunk 6.6.2 will be the second part of the sixth part of the sixth script
* Some parts of the code are heavily commented to facilitate understanding by new users of R and microbiome analyses. 
### details about each script in the pipeline
*1_Loading_and_pre_processing.Rmd:* After installing the packages with the first chunk, run all chunks. The code will then load, decontaminate, filter and normalize the data. Processed phyloseq objects that are ready to use in posterior analysis will be saved as RData files.
*2_beta_diversity.Rmd:* load necessary libraries and data with the first code chunk. The script will then perform beta diversity analysis (NMDS plots, permanovas, beta dispersion tests) on different portions of the dataset. The final chunk will save the full R session externally as an RData file. This file (“/R output/analysis_session.RData”) contains all R objects that will be necessary for the subsequent analysis.
*3_alpha diversity.Rmd:* load necessary libraries and data with the first code chunk. The script will then perform alpha diversity analysis (Shannon diversity index plots, ANOVA tests, levene tests, post-hoc tests) on different portions of the dataset (such as all samples or only __A. thaliana__). The final chunk will *overwrite* the full R session externally as an RData file to be loaded on other analysis steps
*4a_neutral_models_rhizosphere.Rmd:* load necessary libraries and data with the first code chunk. The initial chunks also include some graphical aprameters for the plots. Chunks 4.6 to 4.6.3 will define neutral models for rhizosphere samples of __Brassica oleracea__, and also extract neutral model metrics like R2, m, and percentages of ASVs above and below neutrality. Most importantly, one neutral model will be calculated for each of the four experimental treatments (n=6 for each treatment) in __B. oleracea__. The metacommunity for the pool parameter of the tyRa::fit_sncm() function will include all 24 samples of __B. oleracea__. Chunks 4.6.4 to 4.6.8 will add the neutral model fit class to the phyloseq object, which is used for further subsetting. Overlaps of above-neutral ASVs can be seen on the last chunk of this series. The whole 4.7 chunk series will perform the same analysis, but for __A. thaliana__. I apologize, dear reader, for not automating this task. Chunks 4.8 to 4.9.6 will check for possibly introduced biases in this analysis. Most importantly, chunk 4.9.1 will run 1000 permanovas using random ASVs instead of above-neutral ASVs. Chunks 4.9.2 to 3.9.5 will extract and re-shape pR2/F values for the 1000 permanovas, and chunk 4.6 will plot it. Chunk 4.10 will use the metacoder package to prepare the matrixes of heat trees. Chunk 4.12 will calculate the local regressions between above-neutral ASVs and the full communities, which are exported as plots in chunk 4.13. in the end of the script, overwrites the R image to be loaded in the next script. 
*4b_neutral_models_endosphere:* This script is identical to 4a_neutral_models_rhizosphere.Rmd in structure and output, but it targets endosphere samples. I apologize again, dear reader, for not automating this. In the end of the script, overwrites the R image to be loaded in the next script 
*5_differential_abundance.Rmd:* load necessary libraries and data with the first code chunk. The script will then perform differential abudance analysis. Chunk 5.3 will construct the heatmaps of differentially abudannt ASVs. In the end of the script, overwrites the R image to be loaded in the next script
*6_network_analysis.Rmd:* load necessary libraries and data with the first code chunk. This script relies heavily on custom functions that load in chunk 6.1 and  are found in  “./Code/Functions/Network_custom_functions.R". The script will then proceed to perform network analysis, including calculation of the network, calculation of network metrics, comparisons with random networks, and calculation of node metrics. Chunk 6.8 will export data as scv files to be load on Cystoscape for network visualization. All these processed files are present in “/R output/Network files/”. In the end of the script, overwrites the R image to be loaded in the next script.
*7_random_forest.Rmd:* load necessary libraries and data with the first code chunk. The script will then create random forest models to select ASVs that can predict the different treatments within each stress/species combination. RF importance is added ot the phyloseq objects in chunk 7.4, and plots are exported on chunk 7.7. In the end of the script, overwrites the R image to be loaded in the next script.
*8_important_taxa_overrepresentation.Rmd:* load necessary libraries and data with the first code chunk. The script will then make the fisher proportion tests for each taxonomy. Chunk 8.1 will subset the ASVs tagged as important in scripts 5,6 and 7. Chunk 8.2 will load and execute a function to calculate the fisher proportions on all taxa at all taxonomic levels. Chunk 8.3 will extract key metrics from the fisher test, and chunk 8.4 will put these metrics into heat trees. In the end, saves the final analysis session for the microbiome data analysis.
*9_plant_traits.Rmd:* install and load additional packages, then load and prepare plant phenotype data. Chunks 9.2 to 9.7 will run analysis, checks and plots for plant phenotypes (such as plant dry weight)
#### Key custom functions executed in theses scripts
* The histogram of 1000 permanovas’r, f and p values, compared to the full community and above-neutral community, can be reproduced with the code on chunks 4a.9 to 4a.9.6
* The local regression between the above-neutral ASVs and the full community, at every taxa level, can be reproduced with the code on chunk 4a.12
* Several custom functions used on network analysis can be found on "./Code/Functions/Network_custom_functions.R"
* Fisher tests for each taxon, comparing a list of important ASVs to the full community, can be reproduced with code from chunk 8.2. extraction of the p and odds ratio for each taxon can be reproduced with code on chunk 8.3. These results can be visualized on a heat tree with the code on chunk 8.4


