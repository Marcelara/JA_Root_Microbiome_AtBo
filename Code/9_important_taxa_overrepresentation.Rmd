---
title: "9_important_taxa_overrepresentation"
author: "Pedro"
date: "2/7/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---


# 9.0 important taxa overrepresentation
Here we take the output of script 8 that defines teh ASVs that were importnat, and then look into the taxonomies of important taxa. It tests if  these taxa are overperesented in the importnat subset, when compared to the full subset. 

This script will awnser the following question: if 6 out of 17 taxa in RF_importnat of B.Ole roots are from f__Commonadacea, and 211 out of 2453 of the taxas in B.Ole roots are from f__Commonadacea, are these proportions similar or different?

# 9.1 important taxa overrepresentation
set a list of important taxa based on the list of important ASVs
```{r}


#list of ASVs tagged as important (chunk # 8.6.1b )
simplified_ASV_importance_scores


# get the ASV names of any ASV that had any tag (that is, remove uninportnat ASVS)
important_ASV_list<-lapply(simplified_ASV_importance_scores, function(x)
  row.names(x[x$sum_of_tags>0,]))

#as taxas above expected in neutral definitions were not defined in root samples but were explored in other figures, let's remove them from this analysis
important_ASV_list<-lapply(simplified_ASV_importance_scores, function(x){
  x<-x[,c(-2, -5)]
  x$sum_of_tags<-rowSums(x)
  row.names(x[x$sum_of_tags>0,])
})
  



# make list by hand as mapply fails us
ps_imp_taxa_l<-list(
  subset_taxa(ps_list_rarefied$Arabidopsis_thaliana.Root, 
              (taxa_names(ps_list_rarefied$Arabidopsis_thaliana.Root) %in% important_ASV_list$Arabidopsis_thaliana.Root)),
  
  subset_taxa(ps_list_rarefied$Arabidopsis_thaliana.Soil, 
              (taxa_names(ps_list_rarefied$Arabidopsis_thaliana.Soil) %in% important_ASV_list$Arabidopsis_thaliana.Soil)),
  
  subset_taxa(ps_list_rarefied$Brassica_oleraceae.Root, 
              (taxa_names(ps_list_rarefied$Brassica_oleraceae.Root) %in% important_ASV_list$Brassica_oleraceae.Root)),
  
  subset_taxa(ps_list_rarefied$Brassica_oleraceae.Soil, 
                        (taxa_names(ps_list_rarefied$Brassica_oleraceae.Soil) %in% important_ASV_list$Brassica_oleraceae.Soil)))
# assign names to list
names(ps_imp_taxa_l)<-c("Arabidopsis_thaliana.Root",
                         "Arabidopsis_thaliana.Soil",
                         "Brassica_oleraceae.Root",
                        "Brassica_oleraceae.Soil")


```




# 9.2 prepare data and calculate proportions with fisher's exact test

note: There was a problem on the loop when it is called inside the function: objects "i" in the loop were literally passed as charather "i", so classes/orders could not be found. the same code works fine when hard-coded. this was a problem when using phyloseq::subset_taxa(), but not now when using phyloseq::prune_taxa() 

```{r}
# source the function that calculates fisher tests for every taxonomic level
source("./Code/Functions/fisher_test_on_taxa_levels.R") 

# run the custom function voer 2 lists of philoseq objects, one with imporntat taxa and other with the full taxa (for every partition)
fisher_result_l<-mapply(function (x,y)
                   fisher_all_taxa_groups(ps_important_taxa = x, ps_all_taxa = y),
                   x = ps_imp_taxa_l,
                   y = ps_list_rarefied,
                   SIMPLIFY = FALSE)




```


# 9.3 extract p values and odds ratio
Now that we have large lists of fisher tests, let's fish out important metrics for visualization
```{r}

#output
fisher_result_l



# non-adjusted p values for each fisher comparison
lapply(fisher_result_l, function(x) map(x,1))

# confidence interval of odds ratio for each fisher comparison
lapply(fisher_result_l, function(x) map(x,2))

# odds ratio for each fisher comparison
lapply(fisher_result_l, function(x) map(x,3))




#apply FDR correction to the p values
fdr_p_fisher_l<-lapply(fisher_result_l, function (x){
  #single df with all p values
  pvector<-do.call(rbind.data.frame, map(x,1))
  
  # adjust the p value with fdr, then save as a list
  adjusted_p<-p.adjust(p = pvector[[1]],
                          method = "fdr")%>%
                      as.list()
  # adjust names
  names(adjusted_p)<-names(x)

  return(adjusted_p)
  
})



# subset of FDR adjusted significant p values 
lapply (fdr_p_fisher_l, function (x) 
  x[x<0.05])

min3_adjustp<-str(lapply (fdr_p_fisher_l, function (x) 
  x[x<0.1]))



```






# 9.4 make a heat tree of important taxa
metacoder heat trees are made to visualize differences in taxonomic composition, so let's incoporate p and odds ratio values into such trees
```{r}

fisher_to_heatTree<-function(fisher_output_l,
                             ps_important_taxa_l){
#######################################
######## make metacoder object ######## 
#######################################
imp_heat_ps<-ps_important_taxa_l

#remove unecessary taxonomic indo (dada2id, "S__" and" above_selected)
tax_table(imp_heat_ps)<-tax_table(imp_heat_ps)[,1:6]

# transform from phyloseq to  taxmap object
imp_heat<-parse_phyloseq(imp_heat_ps)



#######################################
######## aplly fdr to fisher ######## 
#######################################

#apply FDR correction to the p values

  #single df with all p values
  pvector<-do.call(rbind.data.frame, map(fisher_output_l,1))
  
  # adjust the p value with fdr, then save as a list
  adjusted_p<-p.adjust(p = pvector[[1]],
                          method = "fdr")%>%
                      as.list()
  # adjust names
  names(adjusted_p)<-names(fisher_output_l)

  

#this is the name that mustch match our fisher p list
taxon_id_metacoder<-lapply(imp_heat$taxa, function (x)
                                                    x$get_name())%>%
                                                    map(1)


# now turn that list into a df
taxon_id_metacoder<-do.call(rbind.data.frame, map(taxon_id_metacoder,1))

# and change column name
colnames(taxon_id_metacoder)<-"taxa_id"

# truns the p values into a dataframe
adjusted_p_input<-as.data.frame(t(as.data.frame(adjusted_p)))%>%
  rownames_to_column()

#change column names
colnames(adjusted_p_input)<-c("taxa_id", "fdr_p")
  
# now join both df
fdr_for_heatTree<-left_join(taxon_id_metacoder,
                            adjusted_p_input,
                            by = "taxa_id")



#######################################################################
################### add fold changes! ########################################
#######################################################################


# get odds ratio for each taxa
odd_list<- map(fisher_output_l,3)%>%
  map(1)

# truns the p values into a dataframe
odd_list<-as.data.frame(t(as.data.frame(odd_list)))%>%
  rownames_to_column()

#change column names
colnames(odd_list)<-c("taxa_id", "odds_ratio")

# now join both df
fisher_for_heatTree<-left_join(fdr_for_heatTree,
                            odd_list,
                            by = "taxa_id")




#NAs will crash metadore. let's change them with 0.9999 for now
fisher_for_heatTree[is.na(fisher_for_heatTree)]<-"0.99999"

#change structure to numeric
fisher_for_heatTree$fdr_p<-as.numeric(fisher_for_heatTree$fdr_p)
fisher_for_heatTree$odds_ratio<-as.numeric(fisher_for_heatTree$odds_ratio)


#now let's dim p values above 0.1, or else we can get counfounded
#fisher_for_heatTree$fdr_p[fisher_for_heatTree$fdr_p>0.1]<-1







#######################################################################
############### now plot the heat tree ############### 
#######################################################################



set.seed(1)
      output<- heat_tree(imp_heat,
                 node_size = fisher_for_heatTree$odds_ratio, # n_obs is a function that calculates, in this case, the number of OTUs per taxon
                 node_color = fisher_for_heatTree$fdr_p,
                 node_label = taxon_names,
                 node_size_axis_label = "Size: oods_ratio",
                 node_color_interval = c(0, 0.15),
                 edge_color_interval = c(0, 0.15),
                 node_color_range = c("darkgreen", "seagreen", "yellowgreen", "grey"),
                 edge_color_range = c("darkgreen", "seagreen", "yellowgreen", "grey"),
                 node_color_axis_label = "Color: FDR-adjusted p",
                 layout = "davidson-harel", # The primary layout algorithm
                 initial_layout = "reingold-tilford") # The layout algorithm that initializes node locations

      return(output)
}



mapply(function(x,y)
    fisher_to_heatTree(x,y),
    x = fisher_result_l,
    y = ps_imp_taxa_l,
    SIMPLIFY = FALSE)


```





# 9.5 Check details of F_commamonadaceae and 
Now we look into diversity and abudance of these 2 main taxa, by compartment and plant species. we will do this on the full dataset, on the above-expected taxa list, and on the "importnat" taxa list
```{r}



# define a function to return the plot that we want, providing a single PS object
diversity_barplot<-function(ps_object, title = ""){
#Calculate richness for root and soil
calculated_diversity<-microbiome::diversity(ps_object)

n_sequences<-sample_sums(ps_object)
calculated_diversity$n_sequences<-n_sequences

#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(calculated_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
calculated_diversity_df<-as(sample_data(merge_phyloseq(ps_object,merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe

#Lets see this on a simple boxplot for Shannon diversity index
shannon_plot<-ggplot(calculated_diversity_df, aes(x =MeJA_treatment, y = shannon, fill=Plant_species))+
  geom_boxplot()+
  theme_bw()+
  labs(title = title)+ 
  facet_wrap(~Sample_type)


return(shannon_plot)

}


microbiome::diversity(subset_taxa(physeq_filtered_rarefied, Family == "f__Comamonadaceae"))


# check diversity on full dataset
diversity_barplot(ps_object = subset_taxa(physeq_filtered_rarefied, Family == "f__Comamonadaceae"),
                  title = "All Comamonadaceae")

diversity_barplot(ps_object = physeq_filtered_rarefied,
                  title = "All taxa")




#above neutral, commamonadaceae
list_divesity<-lapply(pslit_neutraly_selected, function (z){

  taxon_diversity<-estimate_richness(subset_taxa(z,  Family == "f__Comamonadaceae"))%>%
  rownames_to_column(var = "Sample")
  taxon_diversity$Sample<-sub("X", "", taxon_diversity$Sample)# why the hell that X popped up? this fix it
taxon_diversity<-column_to_rownames(taxon_diversity, var= "Sample")

n_sequences<-sample_sums(subset_taxa(z,  Family == "f__Comamonadaceae"))
taxon_diversity$n_sequences<-n_sequences

#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(subset_taxa(z,  Family == "f__Comamonadaceae"),merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe

return(taxon_diversity)
  
})
ggplot(do.call(rbind.data.frame, list_divesity), aes(x =MeJA_treatment, y = n_sequences, fill=Plant_species))+
  geom_boxplot()+
  theme_bw()+
  labs(title = "Above Neutral, comamonadaceae")+ 
  facet_wrap(~Sample_type)







#important taxa, comamonadaceae
list_divesity<-lapply(ps_imp_taxa_l, function (z){
taxon_diversity<-microbiome::diversity(subset_taxa(z,  Family == "f__Comamonadaceae"),index = "Shannon")
#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
n_sequences<-sample_sums(subset_taxa(z,  Family == "f__Comamonadaceae"))
taxon_diversity$n_sequences<-n_sequences
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(subset_taxa(z,  Family == "f__Comamonadaceae"),merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe

return(taxon_diversity)
  
})
ggplot(do.call(rbind.data.frame, list_divesity), aes(x =MeJA_treatment, y = n_sequences, fill=Plant_species))+
  geom_boxplot()+
  theme_bw()+
  labs(title = "important, Comamonadaceae")+
  facet_wrap(~Sample_type)









# 




















```


## 9.5.2 test alpha diversity differences in commaomonadaceae 

```{r}




diversity_test<-function(ps_object){
#Calculate richness for root and soil
taxon_diversity<-microbiome::diversity(ps_object,index = "Shannon")


#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(ps_object,merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe


#check homogeniety of variances

levene<-leveneTest((shannon) ~ Plant_species* MeJA_treatment * Sample_type, data = taxon_diversity) 



#two-way anova, shanon diversity index
tx <- with(taxon_diversity, interaction(MeJA_treatment, Plant_species, Sample_type)) #needed for tukey to test interaction
aovTukey<-aov(shannon ~ tx, data = taxon_diversity)#needed for tukey to test interaction
anova_test<-Anova(lm((shannon) ~ Block + Plant_species* MeJA_treatment * Sample_type, data = taxon_diversity, contrasts=list(MeJA_treatment=contr.sum, Plant_species=contr.sum)), type = "2") 
tukey_result<-LSD.test(aovTukey, "tx", group=TRUE, console=TRUE)#post-hoc

output<-list(levene, anova_test, tukey_result)

names(output)<-c("levene", "anova_test", "LSD_result")

return(output)

}
diversity_test_MeJA<-function(ps_object){
#Calculate richness for root and soil
taxon_diversity<-microbiome::diversity(ps_object,index = "Shannon")


#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(ps_object,merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe


#check homogeniety of variances

levene<-leveneTest((shannon) ~  MeJA_treatment, data = taxon_diversity) 



#two-way anova, shanon diversity index
tx <- with(taxon_diversity, interaction(MeJA_treatment)) #needed for tukey to test interaction
aovTukey<-aov(shannon ~ tx, data = taxon_diversity)#needed for tukey to test interaction
anova_test<-Anova(lm((shannon) ~ Block + MeJA_treatment, data = taxon_diversity, contrasts=list(MeJA_treatment=contr.sum, Plant_species=contr.sum)), type = "2") 
tukey_result<-LSD.test(aovTukey, "tx", group=TRUE, console=TRUE)#post-hoc

output<-list(levene, anova_test, tukey_result)

names(output)<-c("levene", "anova_test", "LSD_result")

return(output)

}


diversity_test_oneSampleType<-function(ps_object){
#Calculate richness for root and soil
taxon_diversity<-microbiome::diversity(ps_object,index = "Shannon")


#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(ps_object,merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe


#check homogeniety of variances

levene<-leveneTest((shannon) ~ Plant_species* MeJA_treatment, data = taxon_diversity) 



#two-way anova, shanon diversity index
tx <- with(taxon_diversity, interaction(MeJA_treatment, Plant_species)) #needed for tukey to test interaction
aovTukey<-aov(shannon ~ tx, data = taxon_diversity)#needed for tukey to test interaction
anova_test<-Anova(lm((shannon) ~ Block + Plant_species* MeJA_treatment, data = taxon_diversity, contrasts=list(MeJA_treatment=contr.sum, Plant_species=contr.sum)), type = "2") 
tukey_result<-LSD.test(aovTukey, "tx", group=TRUE, console=TRUE)#post-hoc

output<-list(levene, anova_test, tukey_result)

names(output)<-c("levene", "anova_test", "LSD_result")

return(output)

}




# check diversity on full dataset
diversity_test(ps_object = subset_taxa(physeq_filtered_rarefied, Family == "f__Comamonadaceae"))


lapply(ps_list_rarefied, function(x)
  diversity_test_MeJA(ps_object = subset_taxa(x, Family == "f__Comamonadaceae")))

lapply(pslit_neutraly_selected, function(x)
  diversity_test_MeJA(ps_object = subset_taxa(x, Family == "f__Comamonadaceae")))

lapply(ps_imp_taxa_l, function(x)
  diversity_test_MeJA(ps_object = subset_taxa(x, Family == "f__Comamonadaceae")))





```

## 9.5c - test beta diversity fo comamonadaceae 

```{r}

pslit_neutraly_selected
ps_imp_taxa_l


beta_disp_plotAndTest(phyloseq_list = lapply(ps_list_rarefied, function(x)
                                        subset_taxa(x, Family == "f__Comamonadaceae")),
                      group = "MeJA_treatment")

beta_disp_plotAndTest(phyloseq_list = lapply(pslit_neutraly_selected, function(x)
                                        subset_taxa(x, Family == "f__Comamonadaceae")),
                      group = "MeJA_treatment")

beta_disp_plotAndTest(phyloseq_list = lapply(ps_imp_taxa_l, function(x)
                                        subset_taxa(x, Family == "f__Comamonadaceae")),
                      group = "MeJA_treatment")
                        


  





                        




```
## 9.5d investigate streptomyces

```{r}


diversity_barplot(ps_object = subset_taxa(physeq_filtered_rarefied, Genus == "g__Streptomyces"),
                  title = "All Streptomyces")

diversity_barplot(ps_object = subset_taxa(pslit_neutraly_selected$uni_4model_AT_above, Genus == "g__Streptomyces"),
                  title = "above Streptomyces")

diversity_barplot(ps_object = subset_taxa(ps_imp_taxa_l$Arabidopsis_thaliana.Root, Genus == "g__Streptomyces"),
                  title = "importnat Streptomyces")



beta_disp_plotAndTest(phyloseq_list = lapply(ps_list_rarefied, function(x)
                                        subset_taxa(x, Order == "o__Streptomycetales")),
                      group = "MeJA_treatment")

beta_disp_plotAndTest(phyloseq_list = lapply(pslit_neutraly_selected, function(x)
                                        subset_taxa(x, Order == "o__Streptomycetales")),
                      group = "MeJA_treatment")

beta_disp_plotAndTest(phyloseq_list = lapply(ps_imp_taxa_l[1:2], function(x)
                                        subset_taxa(x, Order == "o__Streptomycetales")),
                      group = "MeJA_treatment")
                                              


```





## 9.5d investigate rhizobiales
```{r}


diversity_barplot(ps_object = subset_taxa(physeq_filtered_rarefied, Order == "o__Rhizobiales"),
                  title = "All Rhizobiales")


#important taxa, rhizobiales
list_divesity<-lapply(ps_imp_taxa_l, function (z){
taxon_diversity<-microbiome::diversity(subset_taxa(z,  Order == "o__Rhizobiales"),index = "Shannon")
#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
n_sequences<-sample_sums(subset_taxa(z,  Order == "o__Rhizobiales"))
taxon_diversity$n_sequences<-n_sequences
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(subset_taxa(z,  Order == "o__Rhizobiales"),merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe

return(taxon_diversity)
  
})
ggplot(do.call(rbind.data.frame, list_divesity), aes(x =MeJA_treatment, y = n_sequences, fill=Plant_species))+
  geom_boxplot()+
  theme_bw()+
  labs(title = "important, rhizobiales")+
  facet_wrap(~Sample_type)





#above neutral, rhizobiales
list_divesity<-lapply(pslit_neutraly_selected, function (z){

  taxon_diversity<-estimate_richness(subset_taxa(z,  Order == "o__Rhizobiales"))%>%
  rownames_to_column(var = "Sample")
  taxon_diversity$Sample<-sub("X", "", taxon_diversity$Sample)# why the hell that X popped up? this fix it
taxon_diversity<-column_to_rownames(taxon_diversity, var= "Sample")

n_sequences<-sample_sums(subset_taxa(z,  Order == "o__Rhizobiales"))
taxon_diversity$n_sequences<-n_sequences

#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(taxon_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
taxon_diversity<-as(sample_data(merge_phyloseq(subset_taxa(z,  Order == "o__Rhizobiales"),merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe

return(taxon_diversity)
  
})
ggplot(do.call(rbind.data.frame, list_divesity), aes(x =MeJA_treatment, y = n_sequences, fill=Plant_species))+
  geom_boxplot()+
  theme_bw()+
  labs(title = "Above Neutral, rhizobiales")+
  facet_wrap(~Sample_type)


```

