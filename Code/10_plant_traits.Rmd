---
title: "10_plant_traits"
author: "Marcela Aragon"
date: "8/17/2022"
editor_options: 
  chunk_output_type: console
---

# 10.0 Plant traits 

During the experiment, several plant traits were measured to characterize the plant's phenotypic response to the different stress treatments. For both *A. thaliana* and *B. oleracea* 1. Dry weight was measured. Additionally 2. Leaf area, 3. Leaf length and 4.Leaf width were measured only for *B. oleraceae* and  5.Number of fruits and 6.Inflorescence dry weight were measure only for Arabidopsis as plants were already flowering. 

Finally, as both plants are phenotypically different *per se* we compared the effects of the treatments between them using Cohen's D 

## Setting up R-studio

```{r}

# set working directory to project directory 

# this will load all key libraries for the whole project
library(vegan)
library(Hmisc)
#library(tyRa)
#library(MicEco)
library(tibble)
library(ggpubr)
library(DHARMa)
library(lmtest)
library(fitdistrplus)
library(emmeans)
library(AICcmodavg)
library(jtools)
library(car)
library(multcompView)
library(multcomp)
library(lsr)
library(effsize)
library(gridExtra)
source("./renv/0_load_libraries.R")

# increases memory limit used by R
memory.limit(size = 350000)



```

## Settings for plots

```{r}

# Setting up white background for plots
theme_set(theme_bw())

# Set colors 

#colors & treatments 
color_treatments <- c("#999999", "#E69F00", "#56B4E9", "#009E73")
names(color_treatments) <- c("Control", "MeJA 0.1mM", "MeJA 1mM", "P. brassicae OS")

#color_treatments <- hcl.colors(4,palette="Geyser")
#color_treatments <- c("#E6C186", "#B8CDAE", "#008585", "#C7522B")

#color_species <- c("#009E73", "#D55E00")

#color_compartment <- c()

# Set axis looks
axis_looks <- theme(axis.text.x = element_text(colour = "black", size = 10,
                                               face = "bold", angle=0, hjust=0.5))+
  theme(axis.text.y = element_text(colour = "black", size = 10, face = "bold"))+
  theme(axis.title=element_text(size=12, face = "bold"))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)))+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  theme(legend.position="none")

treatment_names <- c("control" = "Control", "MeJA_0.1" = "0.1 mM \n MeJA",
                      "MeJA_1.0" = "1.0 mM \n MeJA", "oral_secretion"="P. brassicae \n OS")

```



## Load data 

```{r}
# load data 
traits <- read.csv("./Data/MeJA_Plant_traits_raw.csv")
str(traits)

traits[c(1:6)] <- lapply(traits[c(1:6)], factor)

#removing X column 
traits <- traits[-c(19)]

#ordering levels
levels(traits$species)
levels(traits$treatment)

#summary
summary(traits)

#df for Atha
Atha <- traits %>% dplyr::filter(species == "Arabidopsis_thaliana") %>% 
                   mutate(aboveground_dw = ldry_weight + inflorescence)
#df for Bole
Bole <- traits %>% dplyr::filter(species == "Brassica_oleraceae")

#df list 
l_sp <- list(Atha, Bole)
names(l_sp) <- c("Arabidopsis_thaliana", "Brassica_oleraceae")

```

## Load functions
```{r}

#functions to check data distribution and run GLMs

source("./Code/Functions/data_distribution_and_GLM_functions.R")

```


**Look for ways of saving plots with par and making a single figure with plots**

## 10.1 Dry weight

### Plots

```{r}

#Boxplot both
p.dw.spp <- ggplot(data = traits,
                    mapping = aes(x = treatment, y = ldry_weight), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="Shoot biomass(g dry weight)", x=" ") +
  facet_wrap(~species, scales = "free_y")+
  axis_looks

#Boxplot Atha
p.dw.Atha <- ggplot(data = l_sp$Arabidopsis_thaliana,
                    mapping = aes(x = treatment, y = ldry_weight), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="Shoot biomass(g dry weight)", x=" ") +
  axis_looks
  
#Boxplot Bole
p.dw.Bole <- ggplot(data = l_sp$Brassica_oleraceae,
                    mapping = aes(x = treatment, y = ldry_weight), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="Shoot biomass(g dry weight)", x=" ") +
  axis_looks

#save plots



```

### Data analysis

```{r}
#Arabidopsis

#Checking data distribution
continuous_distribution_plot_table(Atha$ldry_weight) #normal 
hist(Atha$ldry_weight)

#GLM
glm.Atha <- glm_gaussian_Withdf(l_sp$Arabidopsis_thaliana) #Full, but not significant 
Anova(glm.Atha$Full)
summ(glm.Atha$Full)

#no effect of treatment (p=0.8855) nor block (p=0.1391)in A.thaliana biomass (p=0.34)

#Brassica 
continuous_distribution_plot_table(Bole$ldry_weight) #normal 
hist(Bole$ldry_weight)

#GLM
glm.Bole <- glm_gaussian_Withdf(l_sp$Brassica_oleraceae) #Optimal
Anova(glm.Bole$Full)
summ(glm.Bole$Full, digits = 4) #significant difference 

#no effect of treatment (p=0.8855) nor block (p=0.1391)in A.thaliana biomass (p=0.34)

####-Anova
#LM
glm.Bole2 <- lm(
  ldry_weight ~ treatment + Block, 
  data = l_sp$Brassica_oleraceae)

simulateResiduals(glm.Bole2, plot = T) #ok

anova(glm.Bole2)
summary(glm.Bole2)$r.squared

summ(glm.Bole$Optimal)
summary_model(glm.Bole$Optimal, glm.Bole$Null)

#### Anova 

#Post-hoc
emm.Bole <- emmeans(ref_grid(glm.Bole$Full), pairwise ~ treatment)
plot(emm.Bole$emmeans, comparisons = TRUE)

cld <- cld(emm.Bole,
           alpha = 0.05,
           Letters = letters,
           adjust = "tukey")

```

* No effect of treatment (p=0.8855) nor block (p=0.1391)in A.thaliana biomass (LM, p=0.34)
* Significant effect of treatment (p=0.004578) and no effect of Block (p=0.065722) in B. oleracea biomass (LM, p=0.0029)

--> There's only difference between 0.1 and 1% MeJA, but not against control for *B. oleraceae*, for *A. thaliana* there's no difference in dry weight. 

## 10.2 Leaf area

### Plots

```{r}

#Boxplot Bole
p.la.Bole <- ggplot(data = l_sp$Brassica_oleraceae,
                    mapping = aes(x = treatment, y = leaf_area), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="Leaf area(cm2)", x=" ") +
  axis_looks

#save plots

```

### Data analysis

```{r}

#Brassica 
continuous_distribution_plot_table(Bole$leaf_area) #normal 
hist(Bole$leaf_area)

#LM
lm.la.Bole <- lm(
  leaf_area ~ treatment + Block, 
  data = l_sp$Brassica_oleraceae)

simulateResiduals(lm.la.Bole, plot = T) #ok

Anova(lm.la.Bole)
summary(lm.la.Bole)

#Post-hoc
emm.la.Bole <- emmeans(ref_grid(lm.la.Bole), pairwise ~ treatment)

plot(emm.la.Bole$emmeans, comparisons = TRUE)

cld.la <- cld(emm.la.Bole,
           alpha = 0.05,
           Letters = letters,
           adjust = "tukey")

```

MeJA 1% had significantly lower leaf area than the rest of the treatments. 

## 10.3 Leaf lenght

### Plots

```{r}

#Boxplot Bole
p.l.Bole <- ggplot(data = l_sp$Brassica_oleraceae,
                    mapping = aes(x = treatment, y = length), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="Leaf length (cm)", x=" ") +
  axis_looks

#save plots

```

### Data analysis

```{r}

#Brassica 

#remove NA
Bole <- Bole %>% 
        dplyr::filter(id != "31") %>% droplevels()

#check distribution
continuous_distribution_plot_table(Bole$length) #normal 
hist(Bole$length)

#LM
lm.l.Bole <- lm(
  length ~ treatment + Block, 
  data = l_sp$Brassica_oleraceae)

simulateResiduals(lm.l.Bole, plot = T) #ok

Anova(lm.l.Bole)
summary(lm.la.Bole)


```

No effect of treatment nor block on leaf area for *B. oleracea*

## 10.4 Leaf width 
### Plots

```{r}

#Boxplot Bole
p.w.Bole <- ggplot(data = l_sp$Brassica_oleraceae,
                    mapping = aes(x = treatment, y = width), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="Leaf width (cm)", x=" ") +
  axis_looks

#save plots

```

### Data analysis

```{r}

#Brassica 

#check distribution
#continuous_distribution_plot_table(Bole$width) #normal 
hist(Bole$width)

#LM
lm.w.Bole <- lm(
  width ~ treatment + Block, 
  data = l_sp$Brassica_oleraceae)

simulateResiduals(lm.w.Bole, plot = T) #ok

Anova(lm.w.Bole)
summary(lm.w.Bole)

```

No significant effect of treatment nor block on leaf width for *B. oleracea*

## 10.5 Number of Fruits (Arabidopsis)

### Plots
```{r}

#Boxplot Atha
p.nf.Atha <- ggplot(data = l_sp$Arabidopsis_thaliana,
                    mapping = aes(x = treatment, y =number_fruits ), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="number of siliques/plant", x=" ") +
  axis_looks

#save plots

```

### Data analysis

```{r}

#Arabidopsis 

#check distribution
continuous_distribution_plot_table(Atha$number_fruits) #normal - gamma 
hist(Atha$number_fruits)

#LM
lm.nf.Atha <- lm(
  number_fruits ~ treatment + Block, 
  data = l_sp$Arabidopsis_thaliana)

simulateResiduals(lm.nf.Atha, plot = T) #not ok

#GLM with Gamma distribution
glm.nf.Atha <- glm (number_fruits ~ treatment + Block,
               family = Gamma (link = "log"),
               data = l_sp$Arabidopsis_thaliana)

simulateResiduals(glm.nf.Atha, plot = T) #ok

Anova(glm.nf.Atha)
summary(glm.nf.Atha)
summ(glm.nf.Atha, digits = 4)

#Post-hoc
emm.nf.Atha <- emmeans(ref_grid(glm.nf.Atha), pairwise ~ treatment, type="response")

plot(emm.nf.Atha$emmeans, comparisons = TRUE)

cld.nf <- cld(emm.nf.Atha,
           alpha = 0.05,
           Letters = letters,
           adjust = "tukey")

```

There was significantly less numbers of siliques on Arabidopsis plants treated with MeJA 1% compared to the other treatments. 


## 10.6 Inforescence dry weight (Arabidopsis)

### Plots
```{r}

#Boxplot Atha
p.inf.Atha <- ggplot(data = l_sp$Arabidopsis_thaliana,
                    mapping = aes(x = treatment, y =inflorescence ), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="inflorescence dry weight", x=" ") +
  axis_looks

#save plots

```

### Data analysis

```{r}

#Arabidopsis 

#check distribution
continuous_distribution_plot_table(Atha$inflorescence) #normal - gamma 
hist(Atha$inflorescence)

#LM
lm.inf.Atha <- lm(
  inflorescence ~ treatment + Block, 
  data = l_sp$Arabidopsis_thaliana)

simulateResiduals(lm.inf.Atha, plot = T) #not ok

Anova(lm.inf.Atha)
summary(lm.inf.Atha)

#Post-hoc
emm.inf.Atha <- emmeans(ref_grid(lm.inf.Atha), pairwise ~ treatment)

plot(emm.inf.Atha$emmeans, comparisons = TRUE)

cld.inf <- cld(emm.inf.Atha,
           alpha = 0.05,
           Letters = letters,
           adjust = "tukey")

```

## 10.8 Aboveground dry weight (Arabidopsis)

### Plots
```{r}

#Boxplot Atha
p.ab.Atha <- ggplot(data = l_sp$Arabidopsis_thaliana,
                    mapping = aes(x = treatment, y =aboveground_dw ), colour= treatment)+
  geom_boxplot(mapping = aes(fill= treatment), position = position_dodge(width = 0.8), lwd=0.8)+
  geom_jitter(mapping = aes(fill = treatment),
                         shape = 21, size = 1.8, color = "black", position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="aboveground dry weight", x=" ") +
  axis_looks

#save plots

```

### Data analysis

```{r}

#Arabidopsis 

#check distribution
continuous_distribution_plot_table(Atha$aboveground_dw) #normal - gamma 
hist(Atha$aboveground_dw)

#LM
lm.ab.Atha <- lm(
  aboveground_dw ~ treatment + Block, 
  data = l_sp$Arabidopsis_thaliana)

simulateResiduals(lm.ab.Atha, plot = T) #not ok

Anova(lm.ab.Atha)
summary(lm.ab.Atha)

#Post-hoc
emm.ab.Atha <- emmeans(ref_grid(lm.ab.Atha), pairwise ~ treatment)

plot(emm.ab.Atha$emmeans, comparisons = TRUE)

cld.inf <- cld(emm.ab.Atha,
           alpha = 0.05,
           Letters = letters,
           adjust = "tukey")

```

Even when using full aboveground weight there's no effect of treatment on A. thaliana dry biomass (although now differences seem bigger)


## 10.8 Gene expression

For now import metadata df in which gene expression measurements are available, after excel file is found, join the excel df with `traits` df by matchin the sample names (i.e. 1_Root) to the plant ID number 


```{r}

#open gene expression df 
qpcr <- read.csv("./Data/qPCR_output.csv")
qpcr[1:6] <- lapply(qpcr[1:6], as.factor)
qpcr <- qpcr %>% 
        dplyr::select(id,Block,species,treatment, MYC2_at_fold_DD, lox2_at_fold_DD)%>% 
        dplyr::rename(myc2 = MYC2_at_fold_DD, lox2=lox2_at_fold_DD)

qpcr <- qpcr %>% 
        tidyr::pivot_longer(cols=5:6,
                     names_to="gene",
                     values_to="rel_exp")


#make summary df
qpcr.summ <- dplyr::group_by(qpcr, species, treatment, gene) %>%
  dplyr::summarise(
    n = dplyr::n(),
    mean = mean(rel_exp, na.rm=TRUE),
    sd = sd(rel_exp, na.rm=TRUE),
    se = sd/sqrt(n)) 

```


###Plots
```{r}
#Arabidopsis 

#Lox2
p.lox2.Atha <- ggplot(data = subset(qpcr.summ, species=="Arabidopsis_thaliana" & gene =="lox2"),
                    mapping = aes(x = treatment, y = mean), colour= treatment)+
  geom_bar(mapping = aes(fill = treatment), color="black", size=0.8, stat = "summary", position = position_dodge(width = 0.8))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.4, size=0.8, position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="relative expression of LOX2", x=" ") +
  scale_x_discrete(labels=treatment_names)+
  axis_looks

#Myc2
p.myc2.Atha <- ggplot(data = subset(qpcr.summ, species=="Arabidopsis_thaliana" & gene =="myc2"),
                    mapping = aes(x = treatment, y = mean), colour= treatment)+
  geom_bar(mapping = aes(fill = treatment), color="black", size=0.8, stat = "summary", position = position_dodge(width = 0.8))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.4, size=0.8, position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="relative expression of MYC2", x=" ") +
  axis_looks

#Brassica
#Lox2
p.lox2.Bole <- ggplot(data = subset(qpcr.summ, species=="Brassica_oleraceae" & gene =="lox2"),
                    mapping = aes(x = treatment, y = mean), colour= treatment)+
  geom_bar(mapping = aes(fill = treatment), color="black", size=0.8, stat = "summary", position = position_dodge(width = 0.8))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.4, size=0.8, position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="relative expression of LOX2", x=" ") +
  axis_looks

#Myc2
p.myc2.Bole <- ggplot(data = subset(qpcr.summ, species=="Brassica_oleraceae" & gene =="myc2"),
                    mapping = aes(x = treatment, y = mean), colour= treatment)+
  geom_bar(mapping = aes(fill = treatment), color="black", size=0.8, stat = "summary", position = position_dodge(width = 0.8))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.4, size=0.8, position = position_dodge(width = 0.8))+
  scale_fill_manual(values = color_treatments)+
  labs(y="relative expression of MYC2", x=" ") +
  axis_looks

plots_genes <- list(p.lox2.Atha, p.lox2.Bole, p.myc2.Atha, p.myc2.Bole)

```




###Data analysis
```{r}

```



## 10.7 Cohen's D comparison 

### Plots
```{r}

```


### Data analysis 
```{r}
#try with lsr package

Ctrl.Bo <- Bole %>% 
           dplyr::filter(treatment == "control") %>% .$ldry_weight
          
  
MeJA_0.1.Bo <- Bole %>% 
           dplyr::filter(treatment == "MeJA_0.1") %>% .$ldry_weight

MeJA_1.Bo <- Bole %>% 
           dplyr::filter(treatment == "MeJA_1.0") %>% .$ldry_weight
  
OS.Bo <- Bole %>% 
           dplyr::filter(treatment == "oral_secretion") %>% .$ldry_weight


cohensD(Ctrl.Bo, MeJA_0.1.Bo) #small 
cohensD(Ctrl.Bo, MeJA_1.Bo) #very high
cohensD(Ctrl.Bo, OS.Bo) #very low

#with effsize

cohen.d(Ctrl.Bo, MeJA_0.1.Bo) #small
cohen.d(Ctrl.Bo, MeJA_1.Bo) #high
cohen.d(Ctrl.Bo, OS.Bo) #nothing 

#Arabidopsis

Ctrl.At <- Atha %>% 
           dplyr::filter(treatment == "control") %>% .$inflorescence
          
  
MeJA_0.1.At <- Atha %>% 
           dplyr::filter(treatment == "MeJA_0.1") %>% .$inflorescence

MeJA_1.At <- Atha %>% 
           dplyr::filter(treatment == "MeJA_1.0") %>% .$inflorescence
  
OS.At <- Atha %>% 
           dplyr::filter(treatment == "oral_secretion") %>% .$inflorescence

#with effsize

cohen.d(Ctrl.At, MeJA_0.1.At) #nothing
cohen.d(Ctrl.At, MeJA_1.At) #medium
cohen.d(Ctrl.At, OS.At) #nothing  


```


```{r}

#using Giauque et al., XXXX reference

z <- yuju(Bole, ldry_weight)




yuju <- function(x, y){

  
Ctrl<- x%>% 
           dplyr::filter(treatment == "control") %>% .$y
          
  
MeJA_0.1<- x %>% 
           dplyr::filter(treatment == "MeJA_0.1") %>% .$y

MeJA_1 <- x %>% 
           dplyr::filter(treatment == "MeJA_1.0") %>% .$y
  
OS <- x %>% 
           dplyr::filter(treatment == "oral_secretion") %>% .$y

list <- list(Ctrl, MeJA_0.1, MeJA_1, OS)

return(list)

}



df_dw <- group_by(Atha, treatment) %>%
  dplyr::summarise(
    n = dplyr::n(),
    mean = mean(inflorescence, na.rm = TRUE),
    sd = sd(inflorescence, na.rm = TRUE)) %>%
    mutate(trait="inflorescence")%>%
    mutate(species="Atha")%>%
    mutate("N-1" = n-1)%>%
    mutate(S2 = sd^2)


a <- (df_dw$`N-1`[1]*df_dw$S2[1])+(df_dw$`N-1`[2]*df_dw$S2[2])
b <- df_dw$n[1]+df_dw$n[2]-2
S <- sqrt(a/b)
c <- (df_dw$mean[2]-df_dw$mean[1])
d <- c/S

#it's the same 


cohensD.MeJA0.1 <- function(x){
  
  #x is a df
  
  A <- 
  
  
}
]





```

It's the same as if using function `cohen.d` from `effsize` package 


Reference suggested by Pedro: https://nph.onlinelibrary.wiley.com/doi/full/10.1111/nph.15504 




#Final Figures

```{r}

aspect_ratio <- 1.5
height <- 7


plots<- list(p.dw.Bole, p.la.Bole, p.inf.Atha, p.nf.Atha) 

Plots_spp <- marrangeGrob(plots, nrow=2, ncol=2, top = "Plant traits")

ggsave(Plots_spp,
       height = 7, width = 7 * aspect_ratio,
       file="./R output/plant_traits.pdf")

```


